# nanobot C端多租户服务架构

## 架构概述

本文档描述基于 nanobot 的 C 端多租户 AI 服务架构，支持为每个用户提供个性化的 AI 助理服务。

## 核心挑战

1. **数据隔离**：每个用户有自己的关注列表、生成的报告
2. **个性化**：不同的关注标的、大V、生成频率
3. **扩展性**：支持数万甚至数十万用户
4. **成本控制**：不能为每个用户起一个独立进程
5. **任务调度**：不同用户有不同的定时需求

## 架构设计

```
┌─────────────────────────────────────────────────────────────┐
│                    应用层 (你的 App)                         │
│         ├─ Web App / Mobile App                             │
│         └─ 用户管理中心（关注配置、报告查看）                 │
└─────────────────────────────────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────┐
│                  API Gateway / BFF                          │
│    负责：认证、路由、用户身份识别、工作空间映射               │
│    关键：JWT Token → 用户ID → Workspace 路径               │
└─────────────────────────────────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────┐
│                  nanobot 服务集群                          │
│  ┌──────────────────────────────────────────────────────┐ │
│  │  共享 Agent 进程（多租户模式）                        │ │
│  │                                                      │ │
│  │   ┌─────────────┐  ┌─────────────┐  ┌─────────────┐   │ │
│  │   │ Workspace   │  │ Workspace   │  │ Workspace   │   │ │
│  │   │ /user_001   │  │ /user_002   │  │ /user_003   │   │ │
│  │   │             │  │             │  │             │   │ │
│  │   │ ├─ AGENTS.md│  │ ├─ AGENTS.md│  │ ├─ AGENTS.md│   │ │
│  │   │ ├─ USER.md  │  │ ├─ USER.md  │  │ ├─ USER.md  │   │ │
│  │   │ ├─ HEARTBEAT│  │ ├─ HEARTBEAT│  │ ├─ HEARTBEAT│   │ │
│  │   │ ├─ memory/  │  │ ├─ memory/  │  │ ├─ memory/  │   │ │
│  │   │ └─ reports/│  │ └─ reports/│  │ └─ reports/│   │ │
│  │   └─────────────┘  └─────────────┘  └─────────────┘   │ │
│  │                                                      │ │
│  │  共享组件：                                           │ │
│  │  ├─ 一个 AgentLoop 实例                               │ │
│  │  ├─ 一个 CronService 实例                             │ │
│  │  ├─ 一个 MessageBus 实例                              │ │
│  │  └─ 统一的 ToolRegistry                              │ │
│  │                                                      │ │
│  └───────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────┘
```

## 核心组件说明

### 1. Workspace 结构

每个用户的隔离工作空间：

```
~/.nanobot/workspaces/
├── user_001/
│   ├── AGENTS.md           # 个性化 Agent 提示词
│   ├── USER.md             # 用户信息、偏好
│   ├── HEARTBEAT.md        # 周期性任务配置
│   ├── SOUL.md             # 人格设定
│   ├── MEMORY.md           # 长期记忆
│   ├── memory/             # 记忆片段存储
│   │   └── stocks_2024.md
│   ├── reports/            # 生成的报告
│   │   ├── daily_20240201.md
│   │   └── weekly_2024w05.md
│   └── config.json         # 用户特定配置
│       {
│         "watchlist": ["AAPL", "TSLA", "BTC"],
│         "influencers": ["@elonmusk", "@raydalio"],
│         "report_schedule": "0 9 * * *",
│         "report_format": "markdown"
│       }
├── user_002/
│   └── ...
└── shared/                   # 共享资源（可选）
    └── templates/
        └── report_template.md
```

### 2. 数据流设计

```
用户关注配置                    报告生成流程
     │                              │
     ▼                              ▼
┌─────────┐                 ┌──────────────────┐
│ App     │ ──保存到────▶  │ User Workspace   │
│ 界面配置 │    API      │  config.json     │
└─────────┘                 └────────┬─────────┘
                                    │
                    ┌───────────────┼───────────────┐
                    │               │               │
                    ▼               ▼               ▼
            ┌──────────┐   ┌──────────┐   ┌──────────┐
            │ CronJob  │   │ Heartbeat│   │ User     │
            │ 定时调度  │   │ 周期检查 │   │ 手动触发 │
            └────┬─────┘   └────┬─────┘   └────┬─────┘
                 │              │              │
                 └──────────────┴──────────────┘
                                │
                                ▼
                    ┌──────────────────────┐
                    │   nanobot Agent      │
                    │  - 读取用户配置       │
                    │  - 搜索最新资讯       │
                    │  - 分析生成报告       │
                    └──────────┬───────────┘
                               │
                               ▼
                    ┌──────────────────────┐
                    │   生成报告文件        │
                    │   reports/{id}.md    │
                    └──────────┬───────────┘
                               │
                               ▼
                    ┌──────────────────────┐
                    │   推送通知给用户      │
                    │   (Push/App/微信)    │
                    └──────────────────────┘
```

## 实施路线图

### 阶段 1（1-2 周）：基础架构
- 实现 WorkspaceManager
- 实现 UserConfigManager
- 修改 AgentLoop 支持动态切换

### 阶段 2（2-3 周）：API 开发
- 实现用户管理 API
- 实现报告服务 API
- 实现即时对话 API

### 阶段 3（1-2 周）：定时任务
- 实现 ReportScheduler
- 集成 APScheduler
- 支持 Cron 表达式

### 阶段 4（1 周）：集成测试
- 多用户并发测试
- 性能压力测试
- 端到端集成测试

### 阶段 5（持续）：优化
- 数据库优化
- 缓存策略
- 监控告警

## 扩展建议

### 1. 大规模用户优化

```
当用户量 > 10,000 时的优化策略：

1. 数据库层
   - 使用 PostgreSQL + 分区表
   - 用户配置缓存到 Redis
   - 报告元数据存数据库，内容存对象存储

2. 计算层
   - 报告生成使用 Celery + Redis 队列
   - 多 Worker 并行处理
   - 用户分片（Shard）到不同实例

3. 存储层
   - 旧报告自动归档到冷存储
   - 使用 CDN 加速报告访问
```

### 2. 成本优化

```python
# 智能调度策略 - 避免高峰期集中执行

class SmartScheduler:
    """智能调度器 - 错峰执行"""
    
    def __init__(self):
        self.user_time_slots = {}
    
    def assign_time_slot(self, user_id: str, preferred_time: str) -> str:
        """分配执行时间槽（错峰）"""
        hour, minute = map(int, preferred_time.split(":"))
        
        # 在 15 分钟窗口内随机分散
        import random
        offset = random.randint(-7, 7)
        new_minute = (minute + offset) % 60
        if new_minute < 0:
            new_minute += 60
        
        assigned_time = f"{hour:02d}:{new_minute:02d}"
        self.user_time_slots[user_id] = assigned_time
        
        return assigned_time
```

---

**文档版本**: 1.0  
**最后更新**: 2024-02-06  
**作者**: AI Assistant
